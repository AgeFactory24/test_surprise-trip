<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KDH3F24B76"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KDH3F24B76');
    </script>

    <meta charset="UTF-8">
    <!-- 基本的なviewport設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 検索除け -->
    <meta name="robots" content="noindex, nofollow">

    <!-- ==========================================
       OGP設定 (LINE等のプレビュー用)
       ※ 公開するURLが決まったら content="" の中身を書き換えてください
    =========================================== -->
    <meta property="og:title" content="Surprise Trip 2025">
    <meta property="og:description" content="旅のしおり">
    <meta property="og:type" content="website">
    <!-- ↓ あなたのサイトのURLに変更してください -->
    <meta property="og:url" content="https://agefactory24.github.io/surprise-trip/">
    <!-- ↓ 表示させたい画像の絶対パス (https://〜) に変更してください -->
    <!-- ここではメインのイラストを指定しています -->
    <meta property="og:image" content="https://agefactory24.github.io/surprise-trip/SotetsuTrio.jpg">

    <title>Surprise Trip 2025</title>
    <!-- Google Fonts: Yomogi (手書き風) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- Base Settings --- */
        :root {
            --color-main: #E63946;
            --color-bg: #FAF9F6;
            --color-text: #4A4A4A;
            --color-accent: #457B9D;
            --font-hand: 'Yomogi', cursive, sans-serif;
            /* JSから設定される背景画像URL用の変数定義 */
            --opening-bg-image: none; 
            
            /* 画像の振動レベル設定 (数値が大きいほど激しく揺れる) */
            --shake-level: 0.8px;
        }

        body {
            font-family: var(--font-hand);
            background-color: var(--color-bg);
            color: var(--color-text);
            /* 画用紙のような微細なテクスチャ */
            background-image: 
                linear-gradient(90deg, rgba(200,200,200,0.05) 1px, transparent 1px),
                linear-gradient(rgba(200,200,200,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow-x: hidden;
        }

        /* --- Hand-drawn Utilities --- */
        .hand-drawn-border {
            border: 2px solid var(--color-text);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            background: white;
            box-shadow: 2px 3px 0px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .hand-drawn-btn {
            background-color: var(--color-accent);
            color: white;
            border: 2px solid var(--color-text);
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .hand-drawn-btn:hover {
            transform: scale(1.05) rotate(-1deg);
            box-shadow: 2px 4px 0px var(--color-text);
        }
        
        /* オレンジ色のボタン */
        .btn-orange {
            background-color: #F4A261;
            color: white;
        }
        .btn-orange:hover {
            background-color: #E76F51;
        }

        /* --- Components --- */
        
        /* Polaroid Photo */
        .polaroid {
            background: white;
            padding: 10px 10px 30px 10px;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.2);
            transform: rotate(-2deg);
            transition: transform 0.3s;
            border: 1px solid #ddd;
        }
        .polaroid:nth-child(even) { transform: rotate(1deg); }
        .polaroid:hover { transform: scale(1.05) rotate(0deg); z-index: 10; }
        .polaroid img {
            width: 100%;
            height: auto;
            filter: sepia(20%);
            display: block;
        }

        /* Timeline */
        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 4px;
            background-image: linear-gradient(to bottom, var(--color-text) 50%, transparent 50%);
            background-size: 4px 20px; /* Dotted line */
            z-index: 0;
        }
        .timeline-progress {
            position: absolute;
            left: 20px;
            top: 0;
            width: 4px;
            background: var(--color-main);
            z-index: 1;
            transition: height 1s ease;
        }
        
        .timeline-items-container {
            position: relative;
            z-index: 10; 
        }

        .timeline-item {
            position: relative;
            padding-left: 50px;
            margin-bottom: 2rem;
            opacity: 1;
            transition: all 0.5s;
            cursor: pointer;
        }
        /* Past events */
        .timeline-item.past { opacity: 0.6; filter: grayscale(80%); }
        /* Current event */
        .timeline-item.current { 
            transform: scale(1.02); 
            opacity: 1;
        }
        .timeline-item.current .hand-drawn-border {
            border-color: var(--color-main);
            box-shadow: 0 0 15px rgba(230, 57, 70, 0.3);
        }

        .time-dot {
            position: absolute;
            left: 14px;
            top: 0;
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--color-text);
            border-radius: 50%;
            z-index: 20;
        }
        .timeline-item.current .time-dot {
            background: var(--color-main);
            transform: scale(1.3);
        }
        .timeline-item.past .time-dot {
            background: var(--color-text);
        }

        /* --- Opening Animation Styles --- */
        #opening-overlay {
            background-image: var(--opening-bg-image);
            background-size: cover;
            background-position: center;
            transition: opacity 1s ease;
            
            position: fixed;
            inset: 0;
            z-index: 40;
            background-color: #FAF9F6; /* 画像ロード前の背景色 */
        }
        
        /* Canvas自体のフェードイン用 */
        .canvas-fade-in {
            animation: simpleFadeIn 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes simpleFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Canvas(画像)のブレンドモード設定 */
        #wave-canvas {
            mix-blend-mode: multiply;
            filter: contrast(1.1); 
            opacity: 0; /* 初期状態を透明にして遅延表示に対応 */
        }

        .map-pin {
            position: absolute;
            color: var(--color-main);
            font-size: 3rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s ease;
        }
        .map-pin.show { opacity: 1; transform: translateY(0); }

        /* --- 42枚画像演出用のスタイル --- */
        #scatter-container {
            position: fixed;
            inset: 0;
            z-index: 25; /* 波紋(z-10)より上、バッジ(z-20と同等以上) */
            pointer-events: none; /* クリックを邪魔しない */
            overflow: hidden;
        }

        /* 画像配置用のラッパー要素 */
        .scatter-wrapper {
            position: absolute;
            /* サイズ定義 */
            width: 15vw; 
            max-width: 200px;
            
            opacity: 0;
            
            /* 出現アニメーション */
            transition: opacity 0.5s ease, transform 0.5s ease;
            
            /* 中心基準で配置するための設定 */
            transform-origin: center;
        }

        /* 画像本体（振動アニメーション） */
        .scatter-img {
            width: 100%;
            height: auto;
            display: block;
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        /* スマホ向け最適化 */
        @media (max-width: 768px) {
            .scatter-wrapper {
                width: 18vw;
                max-width: 120px;
            }
        }
        
        /* 消えるときのクラス (ラッパーに適用) */
        .scatter-wrapper.vanishing {
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0 !important;
        }

        /* 上下左右ランダム振動アニメーション (一律制御) */
        @keyframes random-shake {
            0%   { transform: translate(0, 0); }
            10%  { transform: translate(calc(var(--shake-level) * -0.8), calc(var(--shake-level) * 0.5)); }
            20%  { transform: translate(calc(var(--shake-level) * 0.5),  calc(var(--shake-level) * -0.8)); }
            30%  { transform: translate(calc(var(--shake-level) * -0.5), calc(var(--shake-level) * -0.5)); }
            40%  { transform: translate(calc(var(--shake-level) * 0.8),  calc(var(--shake-level) * 0.3)); }
            50%  { transform: translate(calc(var(--shake-level) * -0.3), calc(var(--shake-level) * 0.8)); }
            60%  { transform: translate(calc(var(--shake-level) * 0.6),  calc(var(--shake-level) * -0.6)); }
            70%  { transform: translate(calc(var(--shake-level) * -0.8), calc(var(--shake-level) * 0.5)); }
            80%  { transform: translate(calc(var(--shake-level) * 0.4),  calc(var(--shake-level) * -0.4)); }
            90%  { transform: translate(calc(var(--shake-level) * -0.2), calc(var(--shake-level) * 0.2)); }
            100% { transform: translate(0, 0); }
        }

        /* タイトル・情報表示用 (画像に変更) */
        .sotetsu-trio-title {
            position: absolute;
            top: 12%; /* 位置調整 */
            left: 0;
            right: 0;
            
            /* 画像としての中央揃え設定 */
            margin: 0 auto; 
            width: 80%;       /* スマホ等で大きすぎないように */
            max-width: 350px; /* PC等で大きすぎないように */
            height: auto;
            display: block;

            z-index: 20; /* 画像(25)より下 */
            opacity: 0;
            transition: opacity 1s ease;
            
            /* テキストシャドウの代わりにドロップシャドウで少し浮き出させる */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .trip-info-container {
            position: absolute;
            bottom: 8%;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 30; /* 情報は一番上 */
            color: white;
            font-family: 'Yomogi', cursive;
            opacity: 0;
            transition: opacity 1s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 0 20px;
        }
        .trip-info-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .trip-info-date {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .trip-info-dest {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            opacity: 0; 
            transform: scale(0.8);
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .trip-info-dest.show {
            opacity: 1;
            transform: scale(1);
        }

        /* --- Tab System --- */
        .tab-btn {
            padding: 10px;
            border-bottom: 3px solid transparent;
            opacity: 0.6;
            transition: all 0.3s;
        }
        .tab-btn.active {
            opacity: 1;
            border-bottom: 3px solid var(--color-main);
            color: var(--color-main);
            transform: scale(1.1);
        }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .fade-out { opacity: 0; pointer-events: none; }
        .fade-in { animation: fadeIn 1s forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Lock Overlay */
        .lock-overlay {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(4px);
        }

        /* Modal */
        .modal-backdrop {
            background: rgba(74, 74, 74, 0.8);
            backdrop-filter: blur(2px);
        }
        
        /* チェキ風モーダル内のスタイル */
        .cheki-card {
            background: white;
            padding: 15px 15px 60px 15px; /* 下部を広く */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transform: rotate(2deg);
            max-width: 100%;
        }
        .cheki-text {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            font-family: 'Yomogi', cursive;
            font-size: 1.2rem;
            color: #555;
        }

        /* オープニング画像の表示位置調整 */
        #opening-image-container {
            /* 画面中央より少し上(35%くらい)に配置 */
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* ヘッダーのリプレイボタン化 */
        header {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        header:active {
            opacity: 0.7;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- パスワードロック画面 (最前面) -->
    <div id="password-overlay" class="fixed inset-0 z-[100] bg-[#FAF9F6] flex flex-col items-center justify-center p-4 text-center hidden">
        <div class="max-w-md w-full relative">
            <i class="ph-fill ph-lock-key text-6xl text-[#E63946] mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">合言葉を入力してください</h2>
            <p class="text-sm text-gray-500 mb-6">※旅行の日付 (4桁) です</p>
            
            <input type="tel" id="password-input" maxlength="4" placeholder="1234" 
                   class="border-2 border-gray-400 rounded-lg p-3 w-32 text-center text-3xl mb-6 font-bold outline-none focus:border-[#E63946] tracking-widest bg-white" />
            
            <button onclick="checkPassword()" class="hand-drawn-btn w-full shadow-lg flex justify-center items-center gap-2">
                <i class="ph-bold ph-key"></i> ロック解除
            </button>
            
            <p id="password-error" class="text-red-500 mt-4 font-bold hidden animate-pulse">
                <i class="ph-bold ph-warning"></i> 違います！
            </p>
        </div>
    </div>

    <!-- LOADING OVERLAY (画像読み込み用) -->
    <div id="loading-overlay" class="fixed inset-0 z-[70] bg-[#FAF9F6] flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#E63946] mb-6"></div>
        <p class="text-xl font-bold text-[#4A4A4A] animate-pulse">Now Loading...</p>
        <p class="text-sm text-gray-400 mt-2">思い出を準備中</p>
    </div>

    <!-- 1. COUNTDOWN OVERLAY -->
    <div id="countdown-overlay" class="fixed inset-0 z-50 bg-[#FAF9F6] flex flex-col items-center justify-center p-4 text-center hidden">
        <div class="max-w-md w-full relative">
            <!-- Decorative Stamps -->
            <!-- ビールジョッキ: 黄色系(text-amber-500) -->
            <i class="ph-fill ph-beer-stein absolute -top-10 right-0 text-4xl text-amber-500 opacity-50"></i>
            <i class="ph-fill ph-flower absolute bottom-20 left-0 text-4xl text-red-300 opacity-50"></i>

            <h1 class="text-2xl mb-2 font-bold text-[#E63946]">SURPRISE TRIP</h1>
            <h2 class="text-xl mb-6">旅のしおり解禁まで</h2>
            
            <!-- Timer -->
            <div id="timer" class="text-5xl md:text-6xl font-bold mb-8 tracking-widest text-[#4A4A4A]">
                00:00:00:00
            </div>

            <!-- Important Message -->
            <div class="hand-drawn-border p-6 mb-8 transform rotate-1 bg-yellow-50">
                <p class="text-red-500 font-bold text-lg mb-2">
                    <i class="ph-fill ph-warning-circle"></i> 重要
                </p>
                <p class="text-xl leading-relaxed font-bold">
                    12月3日(水)は<br>
                    <span class="text-3xl border-b-4 border-red-300 inline-block transform -rotate-2">横浜駅</span> に<br>
                    <span class="text-2xl text-[#E63946]">6:30まで</span><br>
                    にお越しください！
                </p>
            </div>

            <!-- Packing List Button -->
            <button onclick="openModal('packing-modal')" class="hand-drawn-btn w-full max-w-xs mx-auto flex items-center justify-center gap-2">
                <i class="ph-bold ph-backpack"></i>
                持ち物リストを見る
            </button>
        </div>
    </div>

    <!-- 2. OPENING ANIMATION OVERLAY -->
    <div id="opening-overlay" class="fixed inset-0 z-40 hidden flex items-center justify-center overflow-hidden">
        <div class="relative w-full h-full flex items-center justify-center p-4">
            
            <!-- 上部タイトル -->
            <img src="MySotetsuisBad.PNG" class="sotetsu-trio-title" alt="My Sotetsu is Bad">

            <!-- 散らばる画像のコンテナ -->
            <div id="scatter-container"></div>

            <!-- Opening Image Container (Center Fixed) -->
            <div id="opening-image-container" class="w-full max-w-md relative z-10 flex justify-center items-center">
                <!-- 白枠(polaroid)クラスを削除し、透明背景に変更 -->
                <div class="rotate-0 transition-transform">
                    <!-- CANVAS for Wave Effect -->
                    <canvas id="wave-canvas" class="w-full h-auto block"></canvas>
                </div>
            </div>
            
            <!-- 下部情報表示 -->
            <div id="trip-info" class="trip-info-container">
                <h2 class="trip-info-title">Birthday Homerun Tour</h2>
                <p class="trip-info-date">2025.12.3(Wed). & 12.4(Thu)</p>
                <div id="trip-dest" class="trip-info-dest">新潟県！</div>
                
                <!-- しおりを開くボタン (オレンジ色) -->
                <button onclick="finishOpeningAnimation()" class="mt-4 hand-drawn-btn btn-orange shadow-lg pointer-events-auto">
                    しおりを開く
                </button>
            </div>
        </div>
    </div>

    <!-- 3. MAIN CONTENT (ITINERARY) -->
    <div id="main-content" class="hidden min-h-screen pb-20">
        <!-- Header -->
        <!-- タイトル部分をクリックでアニメーション再再生 (リセット機能) -->
        <header class="p-4 flex items-center justify-center sticky top-0 z-30 bg-[#FAF9F6]/90 backdrop-blur-sm border-b-2 border-gray-200 border-dashed cursor-pointer"
                onclick="replayOpeningAnimation()">
            <div class="flex items-center gap-2 pointer-events-none">
                <h1 class="text-xl font-bold">Surprise Trip</h1>
                <!-- 高さh-7でテキストサイズに合わせる -->
                <img src="hand_3.png" alt="icon" class="h-7 w-auto object-contain" onerror="this.style.display='none'">
            </div>
        </header>

        <!-- Tabs -->
        <nav class="flex justify-center gap-4 pt-4 px-4 mb-6">
            <button onclick="switchTab('day1')" id="tab-day1" class="tab-btn active text-lg font-bold">Day 1<br><span class="text-xs font-normal">12/03</span></button>
            <button onclick="switchTab('day2')" id="tab-day2" class="tab-btn text-lg font-bold">Day 2<br><span class="text-xs font-normal">12/04</span></button>
            <button onclick="switchTab('memories')" id="tab-memories" class="tab-btn text-lg font-bold">思い出<br><span class="text-xs font-normal">Photo</span></button>
        </nav>

        <!-- Content Container -->
        <main class="max-w-md mx-auto px-4 relative">
            
            <!-- Day 1 -->
            <section id="day1-content" class="tab-content">
                <div class="relative">
                    <div class="timeline-line"></div>
                    <div class="timeline-progress" id="progress-day1" style="height: 0;"></div>
                    <div id="day1-items" class="timeline-items-container"></div>
                </div>
            </section>

            <!-- Day 2 -->
            <section id="day2-content" class="tab-content hidden">
                <div id="day2-lock" class="hidden text-center py-20">
                    <i class="ph-duotone ph-lock-key text-6xl text-gray-300 mb-4"></i>
                    <p class="text-lg">まだ秘密です！<br>1日目の夜をお楽しみに。</p>
                </div>
                <div id="day2-list" class="relative">
                    <div class="timeline-line"></div>
                    <div class="timeline-progress" id="progress-day2" style="height: 0;"></div>
                    <div id="day2-items" class="timeline-items-container"></div>
                </div>
            </section>

            <!-- Memories -->
            <section id="memories-content" class="tab-content hidden relative">
                <!-- Locked State -->
                <div id="memories-lock" class="absolute inset-0 z-10 flex flex-col items-center justify-center pt-20 h-[50vh]">
                    <i class="ph-fill ph-lock text-6xl text-[#E63946] mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">思い出はまだロック中</h3>
                    <p>旅行終了の2週間後<br>(2025/12/17) に解禁されます！</p>
                </div>

                <!-- Unlocked Content -->
                <div id="memories-gallery" class="filter blur-md opacity-50 pointer-events-none transition-all duration-1000">
                    <!-- 写真はJSで注入されます -->
                    <div id="memories-container" class="grid grid-cols-2 gap-4"></div>
                    
                    <div class="mt-8 text-center">
                        <a href="./memories.zip" download class="hand-drawn-btn bg-green-500 border-green-700 inline-flex items-center justify-center gap-2 text-white no-underline">
                            <i class="ph-bold ph-download-simple"></i> 写真一括ダウンロード (ZIP)
                        </a>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Packing List Modal -->
    <div id="packing-modal" class="fixed inset-0 z-[60] hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('packing-modal')"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 h-[80vh] overflow-y-auto shadow-2xl transition-transform transform translate-y-0">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="ph-duotone ph-suitcase text-[#E63946]"></i> 持ち物リスト
            </h2>
            <ul class="space-y-3 text-lg">
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>現金・クレカ・キャッシュカード</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>免許証・保険証・マイナンバーカード</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>充電器(モバイルバッテリー含む)</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>着替え (1日分)</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>部屋着・防寒着</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>バスタオル1枚</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>常備薬（胃腸薬・頭痛薬）</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>洗面用具</span></li>
                <li class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 accent-[#E63946]"> <span>雨具</span></li>
            </ul>
            <button onclick="closeModal('packing-modal')" class="mt-8 w-full hand-drawn-btn bg-gray-200 text-gray-800 border-gray-400">閉じる</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('detail-modal')"></div>
        <div class="relative bg-[#FAF9F6] w-full max-w-md hand-drawn-border p-6 shadow-2xl">
            <button onclick="closeModal('detail-modal')" class="absolute top-2 right-4 text-2xl text-gray-400">&times;</button>
            
            <div id="modal-content-area" class="text-center">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        /* * CONFIGURATION & DATA
         */
        // パスワード設定
        const SITE_PASSWORD_HASH = "MTIwMw==";
        const DEBUG_MODE = true; 
        
        // 日時設定
        const UNLOCK_DATE = new Date("2025-12-03T07:20:00");
        const MEMORY_UNLOCK_DATE = new Date("2025-12-17T00:00:00");
        
        // オープニング画像設定
        const OPENING_IMAGE_URL = "illustration.PNG"; 
        const OPENING_BG_IMAGE_URL = "back.PNG";

        // 画像リスト（ファイル名、拡大率、位置指定）
        // src: ファイル名
        // scale: 表示サイズ倍率 (1.0が基準)
        // top: 上からの位置 (0〜100%), left: 左からの位置 (0〜100%)
        // ※ top/left を指定しない場合、自動的に空いている場所に配置。
        const SCATTER_IMAGES = [
            // 例: ど真ん中に配置したい場合
            //{ src: "IMG_6410.png", scale: 3.0, top: 50, left: 50 },
            // 例: 左上に配置したい場合
            //{ src: "IMG_6399.png", scale: 3.0, top: 15, left: 10 },
            
            // 以下、位置指定なし（自動配置）
            { src: "1.PNG", scale: 3.0 },
            { src: "2.PNG", scale: 3.0 },
            { src: "3.PNG", scale: 3.0 },
            { src: "4.PNG", scale: 3.0 },
            { src: "5.PNG", scale: 3.0 },
            { src: "6.PNG", scale: 3.0 },
            { src: "7.PNG", scale: 3.0 },
            { src: "8.PNG", scale: 3.0 },
            { src: "9.PNG", scale: 3.0 },
            { src: "10.PNG", scale: 3.0 },
            { src: "11.PNG", scale: 3.0 },
            { src: "12.PNG", scale: 3.0 },
            { src: "13.PNG", scale: 3.0 },
            { src: "14.PNG", scale: 3.0 },
            { src: "15.PNG", scale: 3.0 },
            { src: "16.PNG", scale: 3.0 },
            { src: "17.PNG", scale: 3.0 },
            { src: "18.PNG", scale: 3.0 },
            { src: "19.PNG", scale: 3.0 },
            { src: "20.PNG", scale: 3.0 },
            { src: "21.PNG", scale: 3.0 },
            { src: "22.PNG", scale: 3.0 },
            { src: "23.PNG", scale: 3.0 },
            { src: "24.PNG", scale: 3.0 },
            { src: "25.PNG", scale: 3.0 },
            { src: "26.PNG", scale: 3.0 },
            { src: "27.PNG", scale: 3.0 },
            { src: "28.PNG", scale: 3.0 },
            { src: "29.PNG", scale: 3.0 },
            { src: "30.PNG", scale: 3.0 },
            { src: "31.PNG", scale: 3.0 },
            { src: "32.PNG", scale: 3.0 },
            { src: "33.PNG", scale: 3.0 },
            { src: "34.PNG", scale: 3.0 },
            { src: "35.PNG", scale: 3.0 },
            { src: "36.PNG", scale: 3.0 },
            { src: "37.PNG", scale: 3.0 },
            { src: "38.PNG", scale: 3.0 },
            { src: "39.PNG", scale: 3.0 },
            { src: "40.PNG", scale: 3.0 },
            { src: "41.PNG", scale: 3.0 },
            { src: "42.PNG", scale: 3.0 }
        ];
        const DAY1_DATE = "2025-12-03";
        const DAY2_DATE = "2025-12-04";

        const ITINERARY = {
            day1: [
                { 
                    time: "06:30", 
                    icon: "ph-users-three", 
                    title: "横浜駅 集合", 
                    desc: "みんなでワクワク出発！", 
                    img: null,
                    mapUrl: "https://maps.app.goo.gl/spL7HVKSX9sE8E7g7",
                    location: "横浜駅",
                    unlockTime: "06:30" 
                },
                { 
                    time: "07:52", 
                    icon: "ph-train", 
                    title: "東京駅出発", 
                    desc: "新幹線で上越へ出発！", 
                    img: "Tokyo.jpg",
                    mapUrl: "https://maps.app.goo.gl/Y1DLXunyXeGxKdbn8",
                    location: "東京駅",
                    unlockTime: "06:30" 
                },
                { 
                    time: "09:54", 
                    icon: "ph-train", 
                    title: "上越妙高駅到着", 
                    desc: "寒いかな！？新潟県に到着！", 
                    img: "Joetsu.jpg",
                    mapUrl: "https://maps.app.goo.gl/ey7c3EYfeXrXxQeM9",
                    location: "上越妙高駅",
                    unlockTime: "09:54"
                },
                { 
                    time: "10:00", 
                    icon: "ph-car", 
                    title: "レンタカー借りる", 
                    desc: "安全運転で行きましょう！", 
                    img: null,
                    mapUrl: "https://maps.app.goo.gl/dJUJB7tghgsQvjyY8",
                    location: "タイムズカー 上越妙高駅前"
                },
                { 
                    time: "11:00", 
                    icon: "ph-bowl-food", 
                    title: "昼食", 
                    desc: "皆大好きラーメン！", 
                    img: "Joetsuya.jpg",
                    mapUrl: "https://maps.app.goo.gl/VP81ERcj1fsakhGs6",
                    location: "家系ラーメン 上越家"
                },
                { 
                    time: "12:00", 
                    icon: "ph-camera", 
                    title: "観光スポット①", 
                    desc: "あのライブハウス、海や公園へ", 
                    img: "Myhairisbad.JPG",
                    mapUrl: "https://maps.app.goo.gl/YUBw7nc6T13u1KQ67",
                    location: "聖地巡礼"
                },
                { 
                    time: "15:00", 
                    icon: "ph-mountains", 
                    title: "観光スポット②", 
                    desc: "酒蔵見学！（お酒の試飲あります！）", 
                    img: "Joetsushu.jpg",
                    mapUrl: "https://maps.app.goo.gl/UEDpYemoFYQHCvC18",
                    location: "上越酒造"
                },
                { 
                    time: "16:30", 
                    icon: "ph-house-line", 
                    title: "ホテル チェックイン", 
                    desc: "素敵な宿で一休み。温泉もあります！", 
                    img: "Hotel.jpg",
                    mapUrl: "https://maps.app.goo.gl/Nj3cEwhxrL7jfBfF9",
                    location: "神の宮温泉 かわら亭"
                },
                { 
                    time: "18:50", 
                    icon: "ph-car", 
                    title: "レンタカー返却", 
                    desc: "忘れ物しないように！", 
                    img: null,
                    mapUrl: "https://maps.app.goo.gl/dJUJB7tghgsQvjyY8",
                    location: "タイムズカー 上越妙高駅前",
                    unlockTime: "06:30"
                },
                { 
                    time: "19:00", 
                    icon: "ph-wine", 
                    title: "夜食", 
                    desc: "高田駅周辺で飲み会！", 
                    img: "Takada.jpg",
                    mapUrl: "https://maps.app.goo.gl/hKJQuqchisoJoyno9",
                    location: "高田駅"
                }
            ],
            day2: [
                { 
                    time: "08:00", 
                    icon: "ph-sun", 
                    title: "朝食", 
                    desc: "二日酔いは大丈夫か！？しっかり食べよう！", 
                    img: null,
                    mapUrl: "https://maps.app.goo.gl/Nj3cEwhxrL7jfBfF9",
                    location: "神の宮温泉 かわら亭"
                },
                { 
                    time: "09:30", 
                    icon: "ph-sun", 
                    title: "ホテル チェックアウト", 
                    desc: "宿どうでしたか？2日目も楽しみましょう！", 
                    img: "Hotel.jpg",
                    mapUrl: "https://maps.app.goo.gl/Nj3cEwhxrL7jfBfF9",
                    location: "神の宮温泉 かわら亭",
                    unlockTime: "09:30" 
                },
                { 
                    time: "10:30", 
                    icon: "ph-train", 
                    title: "上越妙高駅出発", 
                    desc: "上越は堪能できたかな？", 
                    img: "Joetsu.jpg",
                    mapUrl: "https://maps.app.goo.gl/Y1DLXunyXeGxKdbn8",
                    location: "上越妙高駅"
                },
                { 
                    time: "12:30", 
                    icon: "ph-train", 
                    title: "新潟駅到着", 
                    desc: "新潟の中心地に到着！", 
                    img: "Nigata.JPG",
                    mapUrl: "https://maps.app.goo.gl/cmWnfJx95jwS8C7d9",
                    location: "新潟駅",
                    unlockTime: "12:30"
                },
                { 
                    time: "13:00", 
                    icon: "ph-coffee", 
                    title: "昼食", 
                    desc: "新潟の郷土料理を堪能！", 
                    img: "Soba.JPG",
                    mapUrl: "https://maps.app.goo.gl/4Tgzpyd3LvtyJcpWA",
                    location: "長岡小嶋屋 新潟駅前店",
                    unlockTime: "12:30"
                },
                { 
                    time: "14:00", 
                    icon: "ph-camera", 
                    title: "観光スポット③", 
                    desc: "また酒蔵見学！（お酒の試飲あります！）", 
                    img: "Imayotsukasa.JPG",
                    mapUrl: "https://maps.app.goo.gl/Ds1bXqwx54Qv7qpJA",
                    location: "今代司酒造"
                },
                { 
                    time: "16:00", 
                    icon: "ph-camera", 
                    title: "観光スポット④", 
                    desc: "〆の日本酒で乾杯！お土産もここで！", 
                    img: "Ponshukan.JPG",
                    mapUrl: "https://maps.app.goo.gl/aCAVtAUYwB5R2bY6A",
                    location: "ぽんしゅ館 新潟驛店"
                },
                { 
                    time: "18:18", 
                    icon: "ph-train", 
                    title: "新潟駅出発", 
                    desc: "楽しめたかな？また来ようね！", 
                    img: "Nigata.JPG",
                    mapUrl: "https://maps.app.goo.gl/cmWnfJx95jwS8C7d9",
                    location: "新潟駅",
                    unlockTime: "18:18" 
                },
                { 
                    time: "20:12", 
                    icon: "ph-flag", 
                    title: "東京駅到着", 
                    desc: "ひとまずお疲れ様でした！横浜へ！", 
                    img: "Tokyo.jpg",
                    mapUrl: "https://maps.app.goo.gl/Y1DLXunyXeGxKdbn8",
                    location: "東京駅",
                    unlockTime: "20:12" 
                }
            ]
        };

        const MEMORIES = [
            { img: "https://placehold.co/400x300/e0e0e0/888?text=Photo+1", msg: "最高の旅の始まり！", rotate: "rotate-2" },
            { img: "https://placehold.co/400x300/e0e0e0/888?text=Photo+2", msg: "美味しかったご飯", rotate: "-rotate-2" },
            { img: "https://placehold.co/400x300/e0e0e0/888?text=Photo+3", msg: "絶景スポットにて", rotate: "rotate-1" },
            { img: "https://placehold.co/400x300/e0e0e0/888?text=Photo+4", msg: "また行きたいね", rotate: "-rotate-3" }
        ];

        /*
         * CORE LOGIC
         */
        document.addEventListener('DOMContentLoaded', () => {
            // 背景画像セット
            document.documentElement.style.setProperty('--opening-bg-image', `url('${OPENING_BG_IMAGE_URL}')`);
            
            // パスワード認証チェック
            const isAuth = localStorage.getItem('site_auth_2025');
            if (isAuth) {
                // 認証済みならパスワード画面を隠してアプリ開始
                document.getElementById('password-overlay').classList.add('hidden');
                initApp();
            } else {
                // 未認証ならパスワード画面を表示
                document.getElementById('password-overlay').classList.remove('hidden');
            }
            
            setInterval(updateTimelineStatus, 60000);
            renderMemories(); 
        });

        // Password Check
        function checkPassword() {
            const input = document.getElementById('password-input');
            const errorMsg = document.getElementById('password-error');
            const val = input.value;
            
            try {
                if (btoa(val) === SITE_PASSWORD_HASH) {
                    localStorage.setItem('site_auth_2025', 'true');
                    document.getElementById('password-overlay').classList.add('hidden');
                    initApp();
                } else {
                    throw new Error("Incorrect password");
                }
            } catch (e) {
                errorMsg.classList.remove('hidden');
                input.classList.add('bg-red-100');
                input.value = '';
                setTimeout(() => {
                    input.classList.remove('bg-red-100');
                }, 500);
            }
        }

        // 画像プリロード用の関数
        function preloadImages(imageUrls) {
            const promises = imageUrls.map(url => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = url;
                    // 成功しても失敗しても次に進むため resolve する
                    img.onload = resolve;
                    img.onerror = resolve; 
                });
            });
            return Promise.all(promises);
        }

        // アプリ初期化 (asyncに変更)
        async function initApp() {
            const now = new Date();
            const isUnlocked = now >= UNLOCK_DATE || DEBUG_MODE;

            if (isUnlocked) {
                const hasSeenMap = localStorage.getItem('hasSeenMap'); 
                
                if (!hasSeenMap) {
                    // アニメーション表示ルート

                    // 1. カウントダウン画面を隠す
                    document.getElementById('countdown-overlay').classList.add('hidden');
                    
                    // 2. Loading画面を表示
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay.classList.remove('hidden');

                    // 3. 必要な画像をリスト化してプリロード
                    // (SCATTER_IMAGESはオブジェクトなので .src プロパティを取り出す)
                    const imagesToLoad = [
                        OPENING_IMAGE_URL,
                        OPENING_BG_IMAGE_URL,
                        "MySotetsuisBad.PNG",
                        ...SCATTER_IMAGES.map(item => item.src)
                    ];

                    // 4. 全画像の読み込み完了を待機
                    await preloadImages(imagesToLoad);

                    // 5. Loadingを隠してアニメーション開始
                    loadingOverlay.classList.add('hidden');
                    startOpeningAnimation();

                } else {
                    // 通常表示ルート（既読）
                    document.getElementById('countdown-overlay').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('fade-in');
                    renderItinerary();
                    checkMemoriesLock();
                }
            } else {
                // カウントダウン画面を表示
                document.getElementById('countdown-overlay').classList.remove('hidden');
                startCountdown();
            }
        }

        // リプレイ機能（リロード）
        function replayOpeningAnimation() {
            localStorage.removeItem('hasSeenMap'); // 次回アニメーションを表示するため削除
            location.reload(); // ページリロード
        }

        /* COUNTDOWN */
        function startCountdown() {
            const timerEl = document.getElementById('timer');
            
            const interval = setInterval(() => {
                const now = new Date();
                const diff = UNLOCK_DATE - now;

                if (diff <= 0) {
                    clearInterval(interval);
                    location.reload();
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                timerEl.innerText = `${days}日 ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        /* OPENING ANIMATION */
        function startOpeningAnimation() {
            const countdown = document.getElementById('countdown-overlay');
            const openingOverlay = document.getElementById('opening-overlay');
            
            // 念の為隠す処理
            countdown.classList.add('hidden'); 
            
            openingOverlay.classList.remove('hidden');
            
            // アニメーション開始までの待機時間（ミリ秒）
            const startDelay = 1500;

            // 1. Show Title (セレクタはクラス名なので変更なしでOK)
            setTimeout(() => {
                document.querySelector('.sotetsu-trio-title').style.opacity = '1';
            }, startDelay + 500);

            // 2. Start Canvas Wave Animation (Infinite)
            setTimeout(() => {
                startCanvasWave();
            }, startDelay);
            
            // 3. Start 30 Images Scatter Sequence
            setTimeout(() => {
                startScatterSequence();
            }, startDelay);
        }

        // Helper: Sleep
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        // 42枚の画像アニメーション (グリッドベース配置 + 反時計回り消失)
        async function startScatterSequence() {
            const container = document.getElementById('scatter-container');
            // スマホ対応: clientWidth/Height使用
            const width = document.documentElement.clientWidth;
            const height = document.documentElement.clientHeight;
            const elements = [];

            // 3秒待機
            await sleep(3000);

            // レスポンシブ対応: 画面幅に応じて列数を変更
            const isMobile = width < 768;
            let cols, rows;

            if (isMobile) {
                // スマホ: 4列
                cols = 4;
                rows = Math.ceil(SCATTER_IMAGES.length / cols);
            } else {
                // PC: 6列
                cols = 6;
                rows = Math.ceil(SCATTER_IMAGES.length / cols);
            }

            // 画面端での見切れを防ぐため、有効エリア(Available Area)を定義
            // 画面の上下左右に余白(マージン)を持たせ、その内側でグリッド計算を行う
            const marginX = width * 0.08;  // 左右に8%ずつの余白
            const marginY = height * 0.12; // 上下に12%ずつの余白 (タイトルや下部情報との被り防止含む)

            const availableWidth = width - (marginX * 2);
            const availableHeight = height - (marginY * 2);

            const cellW = availableWidth / cols;
            const cellH = availableHeight / rows;
            
            const gridPositions = [];
            for(let r=0; r<rows; r++) {
                for(let c=0; c<cols; c++) {
                    gridPositions.push({r, c});
                }
            }
            // シャッフル
            for(let i = gridPositions.length - 1; i > 0; i--){
                const j = Math.floor(Math.random() * (i + 1));
                [gridPositions[i], gridPositions[j]] = [gridPositions[j], gridPositions[i]];
            }

            // グリッド位置の使用カウンター
            let gridIndex = 0;

            // 1. 1枚ずつ出現
            for (let i = 0; i < SCATTER_IMAGES.length; i++) {
                const itemData = SCATTER_IMAGES[i]; // データ取得
                
                // ラッパー要素を作成
                const wrapper = document.createElement('div');
                wrapper.className = 'scatter-wrapper';

                const img = document.createElement('img');
                img.src = itemData.src; // src設定
                img.className = 'scatter-img'; // アニメーション用クラス
                
                wrapper.appendChild(img);

                // サイズ設定
                // スマホの場合は少し控えめにスケール補正
                const mobileScaleAdj = isMobile ? 0.85 : 1.0;
                const scale = itemData.scale * mobileScaleAdj;

                let targetX, targetY;

                // 配置ロジックの分岐
                // top, left の指定がある場合はその座標(%)を使用
                if (itemData.top !== undefined && itemData.left !== undefined) {
                    targetX = width * (itemData.left / 100);
                    targetY = height * (itemData.top / 100);
                } 
                // 指定がない場合は、自動グリッド計算を使用
                else {
                    if (gridIndex < gridPositions.length) {
                        const pos = gridPositions[gridIndex];
                        gridIndex++; // 次のグリッドへ進める

                        // マージン分を足した位置からスタート
                        const centerX = marginX + (pos.c * cellW) + (cellW / 2);
                        const centerY = marginY + (pos.r * cellH) + (cellH / 2);
                        
                        // ズレ幅はセルサイズの30%程度に抑える
                        const randomX = (Math.random() - 0.5) * (cellW * 0.6);
                        const randomY = (Math.random() - 0.5) * (cellH * 0.6);

                        targetX = centerX + randomX;
                        targetY = centerY + randomY;
                    } else {
                        // 万が一グリッドが足りなくなった場合（通常はない）は中央へ
                        targetX = width / 2;
                        targetY = height / 2;
                    }
                }

                wrapper.style.left = `${targetX}px`;
                wrapper.style.top = `${targetY}px`;
                
                // 親要素(wrapper)に位置補正とスケールを適用
                // translate(-50%, -50%) で画像の中心を座標に合わせる
                wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`; 

                // アニメーション用の微振動は子要素(img)に適用
                // ふよふよ(float-shake)ではなく、ランダム振動(random-shake)に変更
                // 開始タイミングをランダムにずらす
                img.style.animation = `random-shake 2s linear infinite -${Math.random() * 2}s`;

                container.appendChild(wrapper);
                // elementsにはwrapperを追加する (消去処理のため)
                elements.push({ el: wrapper, scale: scale });

                requestAnimationFrame(() => wrapper.style.opacity = '1');
                
                await sleep(200);
            }

            // 2. 42枚出揃ったら5秒キープ
            await sleep(5000);

            // 3. 中心からの角度で反時計回りに削除
            // 目標: 上(12時)からスタートして、左(9時) → 下(6時) → 右(3時) の順（反時計回り）
            const cx = width / 2;
            const cy = height / 2;

            elements.forEach(item => {
                const el = item.el;
                const rect = el.getBoundingClientRect();
                const ex = rect.left + rect.width / 2;
                const ey = rect.top + rect.height / 2;
                
                const dx = ex - cx;
                const dy = ey - cy;

                // 通常の角度 (-PI ~ PI) : 右=0, 下=PI/2, 左=PI/-PI, 上=-PI/2
                let rad = Math.atan2(dy, dx);

                // 1. 上(-PI/2)を 0 にするために PI/2 を足す
                //    → 上=0, 右=PI/2, 下=PI, 左=-PI/2(または3PI/2)
                rad += Math.PI / 2;

                // 2. 反時計回りにしたいので符号を反転させる
                //    → 上=0, 右=-PI/2, 下=-PI, 左=PI/2
                rad = -rad;

                // 3. マイナス値を正の数(0~2PI)に正規化
                if (rad < 0) {
                    rad += 2 * Math.PI;
                }
                
                // 結果: 上(0) → 左(PI/2) → 下(PI) → 右(3PI/2)
                item._angle = rad;
            });

            // 角度が小さい順（0に近い順＝上からスタート）にソート
            elements.sort((a, b) => a._angle - b._angle);

            // 順番に消去 (帯のように高速で)
            for (const item of elements) {
                // wrapperにクラスを追加して消去
                item.el.classList.add('vanishing'); 
                await sleep(30); 
            }

            await sleep(500);
            container.innerHTML = ''; 

            // 4. 下部の情報表示開始
            showTripInfo();
        }

        function showTripInfo() {
            const infoContainer = document.getElementById('trip-info');
            const destText = document.getElementById('trip-dest');
            
            // 情報コンテナを表示
            infoContainer.style.opacity = '1';

            // 少し遅れて行き先を表示
            setTimeout(() => {
                destText.classList.add('show');
            }, 2000); 
        }

        // 背景波紋アニメーション
        function startCanvasWave() {
            const canvas = document.getElementById("wave-canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            img.src = OPENING_IMAGE_URL;

            // 既にプリロード済みなので onload は即発火するはずですが、念の為既存ロジックも残す
            if (img.complete) {
                initWave(img);
            } else {
                img.onload = () => initWave(img);
            }

            function initWave(image) {
                canvas.width = image.width;
                canvas.height = image.height;
                canvas.classList.add('canvas-fade-in');

                let t = 0;
                function animateWave() {
                    t += 0.05;
                    const waveOffset = (Math.sin(t * 0.3) * 50 + t * 100) % canvas.height;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    for (let y = 0; y < canvas.height; y++) {
                        const dy = Math.sin((y + t * 10) * 0.07) * 70;
                        const waveZone = (y + waveOffset) % canvas.height;
                        const intensity = waveZone < 120 ? (1 - waveZone / 120) : 0;
                        const shift = dy * intensity;
                        ctx.drawImage(image, 0, y, canvas.width, 1, shift, y, canvas.width, 1);
                    }
                    requestAnimationFrame(animateWave);
                }
                animateWave();
            }
        }

        function finishOpeningAnimation() {
            localStorage.setItem('hasSeenMap', 'true');
            const openingOverlay = document.getElementById('opening-overlay');
            const mainContent = document.getElementById('main-content');
            
            openingOverlay.style.opacity = '0';
            setTimeout(() => {
                openingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainContent.classList.add('fade-in');
                renderItinerary();
                checkMemoriesLock();
            }, 1000);
        }

        /* ITINERARY RENDERING */
        function renderItinerary() {
            const day1Container = document.getElementById('day1-items');
            const day2Container = document.getElementById('day2-items');
            
            day1Container.innerHTML = ITINERARY.day1.map((item, index) => createCard(item, 'day1', index)).join('');
            day2Container.innerHTML = ITINERARY.day2.map((item, index) => createCard(item, 'day2', index)).join('');
            
            // 日付に応じた自動タブ切り替え
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 初期表示タブの決定 (12/4ならDay2、それ以外はDay1)
            // ※ すでにユーザーが操作している場合などを考慮し、初回ロード時のみ効くようにしたいが、
            // ここではシンプルに renderItinerary が呼ばれるタイミング(初期化時)で判定する
            if (todayStr === DAY2_DATE) {
                switchTab('day2');
            } else {
                switchTab('day1');
            }
            
            // updateTimelineStatusはswitchTabの中で呼ばれるのでここでは削除可だが、念のため呼んでおく
            updateTimelineStatus();
            
            // Day 2 Lock Logic (Day2タブの中身のロック表示制御)
            const day2Unlock = new Date(DAY2_DATE + "T00:00:00");
            if (now < day2Unlock && !DEBUG_MODE) {
                document.getElementById('day2-lock').classList.remove('hidden');
                document.getElementById('day2-list').classList.add('hidden');
            } else {
                document.getElementById('day2-lock').classList.add('hidden');
                document.getElementById('day2-list').classList.remove('hidden');
            }
        }

        function createCard(item, day, index) {
            return `
                <div class="timeline-item flex gap-4" data-time="${item.time}" data-day="${day}" onclick="openDetail('${day}', ${index})">
                    <div class="time-dot"></div>
                    <div class="hand-drawn-border p-4 w-full relative bg-white">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-[#E63946] text-lg">${item.time}</span>
                            <i class="${item.icon} text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="font-bold text-xl mb-1">${item.title}</h3>
                        <p class="text-xs text-gray-400 text-right mt-1">タップして詳細 <i class="ph-bold ph-caret-right"></i></p>
                    </div>
                </div>
            `;
        }

        /* MEMORY GALLERY RENDERING */
        function renderMemories() {
            const container = document.getElementById('memories-container');
            container.innerHTML = '';
            
            MEMORIES.forEach((mem, index) => {
                const div = document.createElement('div');
                div.className = `polaroid ${mem.rotate}`;
                div.onclick = () => openMemory(index);
                div.innerHTML = `<img src="${mem.img}" alt="memory">`;
                container.appendChild(div);
            });
        }

        /* OPEN MEMORY */
        function openMemory(index) {
            const mem = MEMORIES[index];
            const content = document.getElementById('modal-content-area');
            content.innerHTML = `
                <div class="cheki-card mx-auto relative">
                    <img src="${mem.img}" class="w-full border border-gray-200">
                    <div class="cheki-text">${mem.msg}</div>
                </div>
            `;
            openModal('detail-modal');
        }

        /* STATUS UPDATES */
        // 進捗線のロジックを「日付・時刻」ベースに完全リニューアル
        function updateTimelineStatus() {
            const now = new Date();
            
            // 今日の日付文字列 (YYYY-MM-DD)
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 現在の時刻 (分換算)
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeVal = currentHours * 60 + currentMinutes;

            // 現在アクティブなタブを取得
            const activeTabId = document.querySelector('.tab-btn.active')?.id;
            if (!activeTabId) return;

            // タブに対応する日付を取得
            let targetDateStr = "";
            let isMemories = false;
            if (activeTabId === 'tab-day1') targetDateStr = DAY1_DATE;
            else if (activeTabId === 'tab-day2') targetDateStr = DAY2_DATE;
            else isMemories = true;

            if (isMemories) return; // 思い出タブ

            const activeSection = document.getElementById(activeTabId.replace('tab-', '') + '-content');
            const progressBar = activeSection.querySelector('.timeline-progress');
            const items = activeSection.querySelectorAll('.timeline-item');

            if (!progressBar || items.length === 0) return;

            // --- A. 日付判定 ---
            
            // ケース1: まだ来ていない日付 (未来)
            // -> 進捗ゼロ
            if (todayStr < targetDateStr) {
                progressBar.style.height = '0px';
                items.forEach(el => el.classList.remove('past', 'current'));
                return;
            }

            // ケース2: 過ぎ去った日付 (過去)
            // -> 進捗100% (最後のカードの下まで伸ばす)
            if (todayStr > targetDateStr) {
                const lastItem = items[items.length - 1];
                // 最後のカードの下端 = top位置 + 高さ
                const fullHeight = lastItem.offsetTop + lastItem.offsetHeight;
                progressBar.style.height = fullHeight + 'px';
                
                items.forEach(el => {
                    el.classList.add('past');
                    el.classList.remove('current');
                });
                return;
            }

            // ケース3: 当日 (現在進行形)
            // -> 時刻に基づいて計算
            let maxOffset = 0;

            items.forEach((el, index) => {
                const timeStr = el.dataset.time; 
                const [h, m] = timeStr.split(':').map(Number);
                const itemTimeVal = h * 60 + m;

                el.classList.remove('past', 'current');
                
                // 予定時刻を過ぎているか？
                if (currentTimeVal >= itemTimeVal) {
                    // 1時間以上過ぎたら past扱い、それまでは current扱い
                    if (currentTimeVal > itemTimeVal + 60) {
                        el.classList.add('past');
                    } else {
                        el.classList.add('current');
                    }

                    // --- バーの高さ計算 ---
                    
                    // 通常は「ドットの位置(+20px)」まで伸ばす
                    let extendHeight = el.offsetTop + 20;

                    // 最後のプランの場合、かつ開始時刻を過ぎていれば「カードの下端」まで伸ばす
                    if (index === items.length - 1) {
                        // 最後のプランに関しては、開始時刻を過ぎたら完了に向かって伸びている表現として下まで伸ばす
                        extendHeight = el.offsetTop + el.offsetHeight;
                    }

                    // 進捗バーの高さ更新（より下の要素に合わせて更新）
                    if (extendHeight > maxOffset) {
                        maxOffset = extendHeight;
                    }
                }
            });

            progressBar.style.height = maxOffset + 'px';
        }

        /* MEMORIES TAB */
        function checkMemoriesLock() {
            const now = new Date();
            if (now >= MEMORY_UNLOCK_DATE || DEBUG_MODE) {
                document.getElementById('memories-lock').classList.add('hidden');
                const gallery = document.getElementById('memories-gallery');
                gallery.classList.remove('blur-md', 'opacity-50', 'pointer-events-none');
            }
        }

        /* MODAL & UI UTILS */
        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            if(id === 'packing-modal') {
                 m.querySelector('div.absolute.bottom-0').classList.add('translate-y-0');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        /* OPEN DETAIL */
        function openDetail(day, index) {
            const item = ITINERARY[day][index];
            const now = new Date();
            
            let eventDateStr = (day === 'day1') ? DAY1_DATE : DAY2_DATE;
            let eventTime = new Date(`${eventDateStr}T${item.time}:00`);
            
            // unlockTimeの設定がある場合はそれを優先、なければ1時間前
            let unlockTime;
            if (item.unlockTime) {
                unlockTime = new Date(`${eventDateStr}T${item.unlockTime}:00`);
            } else {
                unlockTime = new Date(eventTime.getTime() - 60 * 60 * 1000);
            }

            if (now < unlockTime && !DEBUG_MODE) {
                const content = document.getElementById('modal-content-area');
                content.innerHTML = `
                    <div class="py-10 text-center">
                        <i class="ph-duotone ph-lock-key text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-2xl font-bold text-[#E63946] mb-2">まだ秘密です！</h3>
                        <p class="text-lg text-gray-600">
                            この予定は<br>
                            <span class="font-bold text-xl text-[#4A4A4A]">${unlockTime.getHours()}:${String(unlockTime.getMinutes()).padStart(2, '0')}</span><br>
                            に解禁されます。
                        </p>
                        <!-- unlockTimeがある場合は文言を変えるなどしても良いですが、シンプルに統一 -->
                        <p class="text-sm text-gray-400 mt-4">（お楽しみ！）</p>
                    </div>
                `;
                openModal('detail-modal');
                return;
            }

            const mapLink = item.mapUrl ? item.mapUrl : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent('新潟県 ' + item.title)}`;

            const content = document.getElementById('modal-content-area');
            
            // 画像のHTML生成（nullチェック）
            const imgHtml = item.img ? `<div class="polaroid rotate-1 mb-6"><img src="${item.img}" class="w-full"></div>` : '';

            content.innerHTML = `
                <div class="mb-4">
                    <i class="${item.icon} text-6xl text-[#E63946] mb-2"></i>
                    <p class="text-2xl font-bold font-hand text-[#E63946]">${item.time}</p>
                </div>
                
                ${imgHtml}
                
                <!-- メッセージと行き先を表示するエリア -->
                <div class="text-left mb-6 bg-white p-4 rounded-lg hand-drawn-border transform -rotate-1">
                    <p class="text-lg leading-relaxed font-bold text-gray-600 mb-4">
                        ${item.desc}
                    </p>
                    <div class="border-t-2 border-dashed border-gray-200 pt-3">
                        <span class="text-xs text-gray-400 block mb-1">行き先:</span>
                        <h3 class="text-2xl font-bold text-[#E63946] flex items-center gap-2">
                            <i class="ph-fill ph-map-pin"></i> ${item.location || item.title}
                        </h3>
                    </div>
                </div>

                <a href="${mapLink}" target="_blank" 
                   class="hand-drawn-btn w-full block text-center no-underline">
                    <i class="ph-bold ph-map-trifold"></i> Googleマップで見る
                </a>
            `;
            
            openModal('detail-modal');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
                el.classList.remove('text-[#E63946]');
            });
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            updateTimelineStatus();
        }
    </script>
</body>
</html>